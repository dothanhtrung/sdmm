{% include "partial/header.html" %}
{% include "partial/search.html" %}
{% include "partial/sync_reload.html" %}

<main class="flex-grow">
    <div class="px-4 flex justify-start gap-4 ">
        <button
                onclick="handleDelete({{id}})"
                class="bg-red-900 hover:bg-red-700 text-white focus:outline-none focus:shadow-outline font-bold py-2 px-4 rounded"
        >
            Delete
        </button>
        <button
                onclick="handleSync({{id}})"
                class="bg-blue-900 hover:bg-blue-700 text-white focus:outline-none focus:shadow-outline font-bold py-2 px-4 rounded"
        >
            Update info from Civitai
        </button>
    </div>

    <div class="flex flex-col md:flex-row w-full">
        {% include "partial/loading.html" %}


        <div id="item-content" class="px-2 space-y-6 order-1 md:order-2 w-full">
            <div class="grid sm:grid-cols-1 md:grid-cols-[2fr_1fr] gap-6 w-full">
                <!-- Left: Details -->
                <div class="px-2 space-y-3 w-full order-2 md:order-1">
                    <div><span id="item-name" class="font-bold text-2xl"></span></div>
                    <div><strong class="text-purple-400">Model name:</strong>
                        <div class="border border-gray-800">
                            <span id="item-model"></span>
                        </div>
                    </div>
                    <div><strong class="text-purple-400">Path:</strong><br>
                        <div class="border border-gray-800">
                            <span id="item-path" class="break-all"></span>
                        </div>
                    </div>
                    <div><strong class="text-purple-400">Trained Words:</strong><br>
                        <div class="border border-gray-800">
                            <span id="item-trained-words" class="break-all"></span>
                        </div>
                    </div>

                    <div>
                        <label for="item-tags-edit" class="text-purple-400">Tags:</label><br>
                        <textarea id="item-tags-edit" class="border-b-gray-400 border w-full" rows="5"></textarea>
                        <ul id="tag-hint-box"
                            class="absolute z-10 bg-gray-800 text-white border border-gray-700 rounded mt-1 hidden max-h-40 overflow-y-auto text-sm"></ul>
                        <br>
                        <label for="item-note-edit" class="text-purple-400">Note:</label>
                        <textarea id="item-note-edit" class="border-b-gray-400 border w-full" rows="5"></textarea>
                        <button id="save-btn"
                                class="mt-3 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-500 transition">
                            Save
                        </button>
                    </div>

                    <div><strong class="text-purple-400">Civitai:</strong><br>
                        <div class="border border-gray-800">
                            <a id="item-civitai" class="break-all"></a>
                        </div>
                    </div>

                    <div><strong class="text-purple-400">Description:</strong><br>
                        <div class="border border-gray-800">
                            <a id="item-description" class="break-all text-green-300"></a>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-xl font-bold mb-2 text-purple-400">Info</h2>
                        <pre id="item-info"
                             class="bg-gray-900 p-4 rounded text-sm overflow-auto max-h-256 whitespace-pre-wrap border border-gray-800"></pre>
                    </div>
                </div>

                <div class="md:order-2 order-1 w-full">
                    <div class="w-full">
                        <video id="item-video" controls
                               class="w-full rounded shadow border border-gray-700 hidden"></video>
                        <img id="item-preview" src="" alt="Preview"
                             class="w-full rounded shadow border border-gray-700 hidden">
                    </div>

                    <div id="image-meta" class="mt-4">
                        <h3 class="text-lg font-bold mb-2 text-purple-400">Image Generation Info</h3>
                        <div class="bg-gray-900 p-3 rounded border border-gray-800 space-y-2 text-sm">
                            <div id="meta-model" class="">
                                <span class="text-purple-300 font-semibold">Model:</span>
                                <span id="meta-model-value"></span>
                            </div>
                            <div id="meta-size" class="">
                                <span class="text-purple-300 font-semibold">Size:</span>
                                <span id="meta-size-value"></span>
                            </div>
                            <div id="meta-cfg" class="">
                                <span class="text-purple-300 font-semibold">CFG Scale:</span>
                                <span id="meta-cfg-value"></span>
                            </div>
                            <div id="meta-clip" class="">
                                <span class="text-purple-300 font-semibold">CLIP Skip:</span>
                                <span id="meta-clip-value"></span>
                            </div>
                            <div id="meta-sampler" class="">
                                <span class="text-purple-300 font-semibold">Sampler:</span>
                                <span id="meta-sampler-value"></span>
                            </div>
                            <div id="meta-steps" class="">
                                <span class="text-purple-300 font-semibold">Steps:</span>
                                <span id="meta-steps-value"></span>
                            </div>
                            <div id="meta-seed" class="">
                                <span class="text-purple-300 font-semibold">Seed:</span>
                                <span id="meta-seed-value"></span>
                            </div>
                            <div id="meta-prompt" class="">
                                <span class="text-purple-300 font-semibold">Prompt:</span>
                                <div class="mt-1 p-2 bg-gray-800 rounded text-gray-200">
                                    <span id="meta-prompt-value"></span>
                                </div>
                            </div>
                            <div id="meta-negative" class="">
                                <span class="text-purple-300 font-semibold">Negative Prompt:</span>
                                <div class="mt-1 p-2 bg-gray-800 rounded text-gray-200">
                                    <span id="meta-negative-value"></span>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

            </div>
        </div>

        {% include "partial/tagbar.html" %}

    </div>
</main>

<script>
    function handleDelete(id) {
        if (!confirm('Are you sure want to move this item to trash?')) return;

        fetch(`/api/item/delete?id=${id}`)
            .then(res => {
                if (res.ok) {
                    window.location.href = "/"; // Redirect to homepage
                } else {
                    alert("Failed to delete the item.");
                }
            })
            .catch(err => {
                console.error("Delete failed:", err);
                alert("Error while deleting.");
            });
    }
</script>

<script>
    async function refreshContent() {
        const res = await fetch("/api/item?id={{id}}");
        const json = await res.json();

        const item = json.items?.[0];
        const tags = json.tags;
        if (!item) return;

        const info = await JSON.parse(item.info || "{}");

        document.getElementById("item-name").textContent = item.name || "";
        document.getElementById("item-model").textContent = info.model?.name || "";
        document.getElementById("item-path").textContent = item.path || "";
        document.getElementById("item-trained-words").textContent = (info.trainedWords || []).join(" ");
        document.getElementById("item-description").innerHTML = item.description || "";

        const modelId = info.modelId || "";
        if (modelId !== "") {
            const civitai_element = document.getElementById("item-civitai");
            civitai_element.href = `https://civitai.com/models/${modelId}`;
            document.getElementById("item-civitai").textContent = `https://civitai.com/models/${modelId}`;
        }

        document.getElementById("item-note-edit").value = item.note || "";

        const img_preview = document.getElementById("item-preview");
        const vid_preview = document.getElementById("item-video");
        img_preview.src = item.preview || "";
        vid_preview.src = item.video_preview || "";
        if (item.video_preview) {
            vid_preview.classList.remove("hidden");
            img_preview.classList.add("hidden");
        } else {
            img_preview.classList.remove("hidden");
            vid_preview.classList.add("hidden");
        }

        displayImageMeta(info);

        display_tag(tags);
        const tagEditBox = document.getElementById("item-tags-edit");
        (tags || []).forEach(tag => {
            tagEditBox.append(tag.tag + " ");
        });


        document.getElementById("item-info").textContent = formatJson(item.info);


        function displayImageMeta(info) {
            if (!info || !info.images || info.images.length === 0) {
                return 0;
            }
            const imageMeta = info.images[0].meta;
            if (!imageMeta) return;

            const metaContainer = document.getElementById("image-meta");
            let hasMetaData = false;

            // Helper function to set metadata field
            function setMetaField(fieldId, valueId, value) {
                if (value !== undefined && value !== null && value !== "") {
                    document.getElementById(fieldId).classList.remove("hidden");
                    document.getElementById(valueId).textContent = value;
                    hasMetaData = true;
                }
            }

            // Set each metadata field
            setMetaField("meta-model", "meta-model-value", imageMeta.Model);
            setMetaField("meta-size", "meta-size-value", imageMeta.Size);
            setMetaField("meta-cfg", "meta-cfg-value", imageMeta.cfgScale);
            setMetaField("meta-clip", "meta-clip-value", imageMeta.clipSkip);
            setMetaField("meta-sampler", "meta-sampler-value", imageMeta.sampler);
            setMetaField("meta-steps", "meta-steps-value", imageMeta.steps);
            setMetaField("meta-seed", "meta-seed-value", imageMeta.seed);
            setMetaField("meta-prompt", "meta-prompt-value", imageMeta.prompt);
            setMetaField("meta-negative", "meta-negative-value", imageMeta.negativePrompt);

            // Show the metadata container if we have any data
            if (hasMetaData) {
                metaContainer.classList.remove("hidden");
            }
        }


        function formatJson(infoStr) {
            try {
                return JSON.stringify(JSON.parse(infoStr), null, 2);
            } catch (e) {
                return infoStr;
            }
        }
    }

    async function handleSync(id) {
        await fetch(`/api/maintenance/sync_civitai?id=${id}`);
        await refreshContent();
    }

    document.addEventListener("DOMContentLoaded", async () => {
        await refreshContent();
    });
</script>

<script>
    document.getElementById("save-btn").addEventListener("click", async () => {
        const tags = document.getElementById("item-tags-edit").value;
        const note = document.getElementById("item-note-edit").value;

        // Extract ID from URL
        const match = window.location.pathname.match(/\/item\/(\d+)/);
        if (!match) {
            alert("Invalid item ID in URL.");
            return;
        }
        const item_id = parseInt(match[1]);

        const response = await fetch("/api/item/update", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({tags, item_id, note})
        });

        if (response.ok) {
            // Reload on success
            window.location.reload();
        } else {

        }
    });
</script>

<script>
    let allTags = [];

    async function fetchTags() {
        const res = await fetch("/api/tag");
        if (res.ok) {
            allTags = await res.json(); // assumed [{ tag, count }]
        }
    }

    fetchTags();

    const textarea = document.getElementById("item-tags-edit");
    const hintBox = document.getElementById("tag-hint-box");

    // Helper: get word under cursor
    function getWordAtCursor(text, pos) {
        const left = text.slice(0, pos);
        const right = text.slice(pos);

        const leftMatch = left.match(/[\w-]+$/);  // include word chars and dashes
        const rightMatch = right.match(/^[\w-]+/);

        const start = leftMatch ? pos - leftMatch[0].length : pos;
        const end = rightMatch ? pos + rightMatch[0].length : pos;
        const word = text.slice(start, end);

        return {word, start, end};
    }

    textarea.addEventListener("input", () => {
        const text = textarea.value;
        const cursor = textarea.selectionStart;
        const {word, start, end} = getWordAtCursor(text, cursor);

        if (!word || word.length < 1) {
            hintBox.classList.add("hidden");
            return;
        }

        const matches = allTags
            .filter(t => t.tag.toLowerCase().includes(word.toLowerCase()))
            .slice(0, 10);

        if (matches.length === 0) {
            hintBox.classList.add("hidden");
            return;
        }

        hintBox.innerHTML = "";
        for (const match of matches) {
            const li = document.createElement("li");
            li.textContent = `${match.tag}`;
            li.className = "px-2 py-1 cursor-pointer hover:bg-purple-600";
            li.addEventListener("click", () => {
                const newValue = text.slice(0, start) + match.tag + text.slice(end);
                textarea.value = newValue;
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + match.tag.length;
                hintBox.classList.add("hidden");
            });
            hintBox.appendChild(li);
        }

        hintBox.classList.remove("hidden");
    });

</script>


{% include "partial/footer.html" %}