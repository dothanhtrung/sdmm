<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script>
        // Apply saved theme ASAP to avoid flash
        (function(){
            try {
                var t = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', t);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link href="/css/tailwind_output.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <title>SDMM</title>

    <style>
        select option:checked {
            background-color: var(--accent);
            color: white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

<div class="w-full flex items-center justify-between shadow-md px-4 py-3">

    <div class="flex items-center space-x-5">
        <!--        <img src="/assets/icon.png" alt="" class="w-8 h-8"/>-->
        <a href="/"><span class="text-2xl font-bold">SDMM</span></a>
        <nav class="flex items-center space-x-4 ml-6">
            <a href="/" class="transition font-bold">Home</a>
            <a href="/civitai" class="transition font-bold">Civitai</a>
            <a href="/maintenance" class="transition font-bold">Maintenance</a>
            <a href="/setting" class="transition font-bold">Setting</a>
        </nav>
    </div>

<!--    <div class="flex items-center gap-2">-->
<!--        <label for="themeSwitcher" class="text-sm">Theme</label>-->
<!--        <select id="themeSwitcher" class="select input-rounded">-->
<!--            <option value="dark">Dark</option>-->
<!--            <option value="light">Light</option>-->
<!--        </select>-->
<!--    </div>-->
</div>

<div id="notify-container" class="fixed top-4 right-4 flex flex-col-reverse gap-2 z-50"></div>

<script>
    // Init theme switcher UI
    (function(){
        const sel = document.getElementById('themeSwitcher');
        if (sel) {
            const cur = document.documentElement.getAttribute('data-theme') || 'dark';
            sel.value = cur;
            sel.addEventListener('change', function(){
                const val = sel.value;
                document.documentElement.setAttribute('data-theme', val);
                try { localStorage.setItem('theme', val); } catch (e) {}
            });
        }
    })();

    const container = document.getElementById("notify-container");

    const levelStyles = {
        Info: "bg-green-600",
        Warn: "bg-yellow-600",
        Error: "bg-red-600"
    };

    function showToast({level, msg}) {
        const baseClasses = "text-white text-md px-4 py-2 rounded shadow-md transition-opacity duration-500";
        const toast = document.createElement("div");
        const timeout = 6000;

        toast.className = `${baseClasses} ${levelStyles[level] || "bg-gray-600"}`;
        toast.textContent = msg;

        container.prepend(toast);

        let fadeTimeout, removeTimeout;

        function startTimer() {
            if (!document.hasFocus()) return;
            fadeTimeout = setTimeout(() => {
                toast.classList.add("opacity-0");
                removeTimeout = setTimeout(() => toast.remove(), 500);
            }, timeout);
        }

        function clearTimers() {
            clearTimeout(fadeTimeout);
            clearTimeout(removeTimeout);
        }

        toast.addEventListener("mouseenter", clearTimers);
        toast.addEventListener("mouseleave", startTimer);

        startTimer();
    }

    const sse = new EventSource("/events");

    sse.onmessage = (event) => {
        try {
            const parsed = JSON.parse(event.data);
            if (parsed.level && parsed.msg) {
                showToast(parsed);
            }
        } catch (e) {
            console.error("Invalid SSE JSON:", event.data);
        }
    };
</script>